<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Page</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href='https://fonts.googleapis.com/css?family=Dancing Script' rel='stylesheet'>
</head>
<body>
    <div class="background-image"></div>
    <div id="flash-messages">
        {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert {% if category == 'success' %}alert-success{% else %}alert-error{% endif %}" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>     
    <nav>
        <a href="#" class="website-name">Dodgeball Throw Analyzer</a>
        <ul>
            <li class="{{ 'active' if request.endpoint == 'home' }}"><a href="/">Home</a></li>
            <li class="{{ 'active' if request.endpoint == 'my_page' }}"><a href="/my-page">My Page</a></li>
            <li class="{{ 'active' if request.endpoint == 'calibration' }}"><a href="/calibration">Calibration</a></li>
            {% if session.get('selected_calibration_id') %}
                <li class="{{ 'active' if request.endpoint == 'measure' }}"><a href="{{ url_for('measure', calibration_id=session.selected_calibration_id) }}">Measure Throw</a></li>
            {% else %}
                <li class="{{ 'active' if request.endpoint == 'measure' }}"><a href="{{ url_for('measure') }}">Measure Throw</a></li>
            {% endif %}
            <li class="{{ 'active' if request.endpoint == 'how_it_works' }}"><a href="/how-it-works">How does it work?</a></li>
            {% if current_user.is_authenticated %}
                <li><a href="{{ url_for('logout') }}">Logout</a></li>
            {% else %}
                <li class="{{ 'active' if request.endpoint == 'login' }}"><a href="{{ url_for('login', next=request.path) }}">Login</a></li>
            {% endif %}
        </ul>
    </nav>
    <div class="container">
        <h1>My Page</h1>
        <p>
            Welcome to your personal page! Here, you can view all the throws you've analyzed using the Dodgeball Throw Analyzer as well as choosing which calibration to use for your next throw measurement. Each throw displays its date, velocity, and distance from the target. You can also visualize the throw by clicking on the button.
        </p>
        <h2>My Throws</h2>
        <table>
            <thead>
                <tr>
                    <th>Throw</th>
                    <th>Date</th>
                    <th>Velocity (km/h)</th>
                    <th>Distance from Target (cm)</th>
                </tr>
            </thead>
            <tbody>
                {% for throw in throws %}
                    <tr>
                        <form action="{{ url_for('remove_throw', throw_id=throw.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this throw?');">
                            <td>
                                <button type="button" class="btn btn-primary btn-sm name-button" id="throw-{{ throw.id }}" onclick="showVisualization(event, {{ throw.id }});" ondblclick="event.preventDefault(); editName(this, '{{ url_for('update_throw_name', throw_id=throw.id) }}');">{{ throw.name }}</button>
                            </td>
                            <td>{{ throw.date.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ throw.velocity }}</td>
                            <td>{{ throw.distance }}</td>
                            <td>
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                                <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                            </td>
                        </form>
                    </tr>
                    <tr class="throw-visualization" id="throw-visualization-{{ throw.id }}" style="display:none;">
                        <td colspan="4">
                            <svg height="450" width="450">
                                <defs>
                                    <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:rgb(181, 179, 179);stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:rgb(0, 0, 0);stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <circle cx="225" cy="225" r="200" fill="white" stroke="black" />
                                <circle cx="225" cy="225" r="180" fill="white" stroke="black" />
                                <circle cx="225" cy="225" r="160" fill="black" stroke="black" />
                                <circle cx="225" cy="225" r="140" fill="black" stroke="white" />
                                <circle cx="225" cy="225" r="120" fill="deepskyblue" stroke="black" />
                                <circle cx="225" cy="225" r="100" fill="deepskyblue" stroke="black" />
                                <circle cx="225" cy="225" r="80" fill="red" stroke="black" />
                                <circle cx="225" cy="225" r="60" fill="red" stroke="black" />
                                <circle cx="225" cy="225" r="40" fill="yellow" stroke="black" />
                                <circle cx="225" cy="225" r="20" fill="yellow" stroke="black" />
                                <circle cx="225" cy="225" r="1" fill="black" />
                                <circle cx="{{ 225 + (throw.accuracy_x * 2) }}" cy="{{ 225 - (throw.accuracy_y * 2) }}" r="6" fill="url(#grad1)" stroke="white" />
                                <line x1="25" y1="20" x2="425" y2="20" stroke="black" stroke-width="2" />
                                <text x="205" y="12" font-size="14px" fill="black">200 cm</text>
                                <line x1="20" y1="25" x2="20" y2="425" stroke="black" stroke-width="2" />
                                <text x="15" y="245" font-size="14px" fill="black" transform="rotate(-90,15,245)">200 cm</text>
                            </svg>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <h2>My Calibrations</h2>
        <table>
            <thead>
                <tr>
                    <th>Calibration</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for calibration in calibrations %}
                    <tr>
                        <form action="{{ url_for('remove_calibration', calibration_id=calibration.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this calibration?');">
                            <td>
                                {% set month_day = calibration.date.strftime('%m-%d') %}
                                <button type="button" class="btn btn-primary btn-sm name-button {{ 'selected' if calibration.id == session.get('selected_calibration_id') }}" id="calibration-{{ calibration.id }}" onclick="location.href='{{ url_for('select_calibration', calibration_id=calibration.id) }}';">{{ 'Calibration: ' ~ month_day }}</button>
                            </td>
                            <td>{{ calibration.date.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                                <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                            </td>
                        </form>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <!-- ... -->
    </div>
    {% block scripts %}
    <script>
        document.querySelectorAll('.name-button').forEach(function (button) {
            button.addEventListener('click', function (event) {
                const throwId = event.target.dataset.throwId;
                const wasSelected = event.target.classList.contains('selected');

                // Deselect all throw buttons
                document.querySelectorAll('.throw-button.selected').forEach(function (selectedButton) {
                    selectedButton.classList.remove('selected');
                    selectedButton.classList.remove('hover-style');
                        });

                if (!wasSelected) {
                    event.target.classList.add('selected');
                    event.target.classList.add('hover-style');
                    showVisualization(throwId);
                } else {
                    hideVisualization();
                }
            });
        });

        document.querySelectorAll('.calibration-button').forEach(function (button) {
            button.addEventListener('click', function (event) {
                const calibrationId = event.target.dataset.calibrationId;

                // Deselect all calibration buttons
                document.querySelectorAll('.calibration-button.selected').forEach(function (selectedButton) {
                    selectedButton.classList.remove('selected');
                    selectedButton.classList.remove('hover-style');
                });

                event.target.classList.add('selected');
                event.target.classList.add('hover-style');
                showCalibration(calibrationId);
            });
        });


        function editName(element, url) {
          const input = document.createElement('input');
          input.value = element.textContent;
          input.classList.add('form-control', 'form-control-sm');
          element.replaceWith(input);
          input.focus();
        
          input.addEventListener('blur', async () => {
            const newName = input.value.trim();
            if (newName !== element.textContent) {
              try {
                const response = await fetch(url, {
                  method: 'POST',
                  body: JSON.stringify({name: newName}),
                  headers: {'Content-Type': 'application/json'}
                });
        
                if (response.ok) {
                  element.textContent = newName;
                } else {
                  console.error('Failed to update the name');
                }
              } catch (err) {
                console.error('Error:', err);
              }
            }
            input.replaceWith(element);
          });
        }
        function showContextMenu(event, element, updateUrl) {
            event.preventDefault();
            var contextMenu = document.createElement("div");
            contextMenu.id = "context-menu";
            contextMenu.style.position = "absolute";
            contextMenu.style.top = event.clientY + "px";
            contextMenu.style.left = event.clientX + "px";
            contextMenu.style.border = "1px solid #ccc";
            contextMenu.style.backgroundColor = "#f9f9f9";
            contextMenu.style.zIndex = "1000";
            contextMenu.style.padding = "8px";
            contextMenu.innerHTML = '<a href="#" onclick="editName(event, \'' + updateUrl + '\', \'' + element.id + '\');">Rename</a>';

            document.body.appendChild(contextMenu);
            window.addEventListener("click", function(event) {
                if (document.getElementById("context-menu")) {
                document.body.removeChild(document.getElementById("context-menu"));
                }
            });
        }
        let selectedThrowId = null;

        function showVisualization(event, throwId) {
            event.preventDefault();
            var visualizationRow = document.getElementById('throw-visualization-' + throwId);
            if (visualizationRow.style.display === 'none') {
                visualizationRow.style.display = 'table-row';
            } else {
                visualizationRow.style.display = 'none';
            }
            if (selectedThrowId !== null) {
                document.getElementById(`throw-${selectedThrowId}`).classList.remove("selected");
            }
            document.getElementById(`throw-${throwId}`).classList.add("selected");
            selectedThrowId = throwId;
        }
    </script>   
    {% endblock %}
</body>
</html>
